<template>
  <v-container fluid>
    <gmap-map
      :center="center"
      :zoom="zoom"
      :options="{fullscreenControl: false, streetViewControl: false, mapTypeControl: false}"
      slot="activator"
      class="map">


      <gmap-polyline :key="path.id" v-for="path in paths" :options="{'strokeColor': path.color, 'strokeWeight': 6}" :path="path.snappedCoordinates" ></gmap-polyline>
      <!-- <heatmap :data="snappedCoordinates" ></heatmap> -->
    </gmap-map>

    <div>
      <svg id="legend" height=150 width=100></svg>
    </div>
  </v-container>
</template>

<script>

import axios from 'axios';
import {loaded, gmapApi} from 'vue2-google-maps';
import Heatmap from '@/components/Heatmap';
import _ from 'lodash';
import * as d3 from 'd3';

export default {
  async created() {
    await this.runSnapToRoad();
  },
  mounted() {
    this.setLegend();
  },
  data() {
    return {
      center: { lat: -22.861659764789806, lng: -43.22840063788988 },
      zoom: 13,
      paths: [],
    };
  },
  computed: {
    google: gmapApi,
  },
  methods: {
    setLegend() {
      var svg = d3.select("#legend")
        .style("position", "absolute")
        .style("right", "10px")
        // .style("background-color", "white")
        .style("top", "0px");

      // Handmade legend
      svg.append("circle").attr("cx",10).attr("cy",50).attr("r", 6).style("fill", "green")
      svg.append("circle").attr("cx",10).attr("cy",70).attr("r", 6).style("fill", "yellow")
      svg.append("circle").attr("cx",10).attr("cy",90).attr("r", 6).style("fill", "orange")
      svg.append("circle").attr("cx",10).attr("cy",110).attr("r", 6).style("fill", "red")
      svg.append("text").attr("x", 30).attr("y", 50).text("0-9").style("font-size", "14px").attr("alignment-baseline","middle")
      svg.append("text").attr("x", 30).attr("y", 70).text("10-19").style("font-size", "14px").attr("alignment-baseline","middle")
      svg.append("text").attr("x", 30).attr("y", 90).text("20-39").style("font-size", "14px").attr("alignment-baseline","middle")
      svg.append("text").attr("x", 30).attr("y", 110).text(">40").style("font-size", "14px").attr("alignment-baseline","middle")
    },
    async runSnapToRoad(path) {
      var pathValues = [
        "-22.91786373,-43.24705558",
        "-22.91765307,-43.24534777",
        "-22.91734733,-43.24391027",
        "-22.91705271,-43.242477",
        "-22.91704565,-43.24245743",
        "-22.91677556,-43.24134835",
        "-22.91647701,-43.23904644",
        "-22.91614004,-43.23718893",
        "-22.91597462,-43.23587119",
        "-22.91596102,-43.23586924",
        "-22.9146078,-43.23376945",
        "-22.91448082,-43.23360262",
        "-22.91433112,-43.23340576",
        "-22.91538595,-43.23234093",
        "-22.91578144,-43.23174912",
        "-22.91574339,-43.23157724",
        "-22.91619641,-43.23027063",
        "-22.91620987,-43.23028371",
        "-22.91617081,-43.22829075",
        "-22.9164546,-43.2265166",
        "-22.91754207,-43.22487945",
        "-22.9181644,-43.22442526",
        "-22.92050683,-43.22277233",
        "-22.92158869,-43.22025502",
        "-22.92121071,-43.21931594",
        "-22.92125678,-43.21914435",
        "-22.92070835,-43.21772955",
        "-22.92030096,-43.21647528",
        "-22.91966809,-43.21484186",
        "-22.91857924,-43.21283215",
        "-22.91834687,-43.21246911",
        "-22.91833423,-43.21242836",
        "-22.91804398,-43.2119079",
        "-22.91773052,-43.21145367",
        "-22.91748987,-43.2113046",
        "-22.91748992,-43.21130849",
        "-22.91720263,-43.21056915",
        "-22.91718771,-43.21056668",
        "-22.9162326,-43.20901829",
        "-22.91574943,-43.20838587",
        "-22.91428126,-43.20546361",
        "-22.91433122,-43.20548813",
        "-22.91401788,-43.20437673",
        "-22.91329978,-43.20291525",
        "-22.9136899,-43.20131998",
        "-22.91390245,-43.20070626",
        "-22.9145231,-43.19847777",
        "-22.91422463,-43.19639855",
        "-22.91419411,-43.19620096",
        "-22.91583257,-43.19451697",
        "-22.9164357,-43.1944831",
        "-22.91918777,-43.19462228",
        "-22.9206134,-43.19380788",
        "-22.93174951,-43.18543634",
        "-22.93174951,-43.18543634",
        "-22.93596641,-43.18387544",
        "-22.93723267,-43.18364432",
        "-22.94023197,-43.18282785",
        "-22.94170279,-43.1822715",
        "-22.94315449,-43.1833823",
        "-22.94475205,-43.18392964",
        "-22.94539615,-43.18405072",
        "-22.94561566,-43.18413558",
        "-22.94598689,-43.1836324",
        "-22.9460251,-43.18361187",
        "-22.94602671,-43.18313531",
        "-22.94606732,-43.18312855",
        "-22.94605858,-43.18312458",
        "-22.94683738,-43.18245306",
        "-22.94747334,-43.18252978",
        "-22.95038918,-43.18154788",
        "-22.95228528,-43.1817873",
        "-22.95340083,-43.18138428",
        "-22.95455827,-43.18091962",
        "-22.9557472,-43.17994632",
        "-22.95568317,-43.17859448",
        "-22.9565485,-43.17769222",
        "-22.96137344,-43.17561848",
        "-22.96264489,-43.17645387",
        "-22.96413001,-43.17872806",
        "-22.96527595,-43.18045488",
        "-22.96526864,-43.18078467",
        "-22.96611244,-43.18190306",
        "-22.96701186,-43.18326877",
        "-22.96712755,-43.18327856",
        "-22.96751196,-43.18400491",
        "-22.96846528,-43.18555454",
        "-22.96903607,-4.3186396",
        "-22.96887939,-43.18644966",
        "-22.96940062,-43.18701874",
        "-22.96997375,-43.18796964",
        "-22.97173218,-43.18992077",
        "-22.97331499,-43.19105743",
        "-22.97394011,-43.19138009",
        "-22.97433729,-43.19158144",
        "-22.97543679,-43.19219587",
        "-22.97549385,-43.19217116",
        "-22.97603891,-43.19239075",
        "-22.97620521,-43.19241502",
        "-22.97809479,-43.19292321",
        "-22.9811963,-43.19260879",
        "-22.98151202,-43.19251294",
        "-22.98303145,-43.19180421",
        "-22.98430525,-43.19156708",
        "-22.98513382,-43.19133794",
        "-22.98558936,-43.1926887",
        "-22.98610644,-43.1950879",
        "-22.9857448,-43.1973942",
        "-22.98567172,-43.19803879",
        "-22.9856266,-43.19949904",
        "-22.98547052,-43.20199229",
        "-22.98552675,-43.20257251",
        "-22.98546941,-43.20341883",
        "-22.98539553,-43.20506612",
        "-22.98514165,-43.20694645",
        "-22.98514662,-43.20695709",
        "-22.98521012,-43.20844135",
        "-22.98509648,-43.21060435",
        "-22.98499501,-43.21205097",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.98500142,-43.21245903",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.9836216,-43.216518",
        "-22.98350639,-43.216134",
        "-22.9835512,-43.21597503",
        "-22.98379914,-43.21401246",
        "-22.98373358,-43.21396672",
        "-22.98369546,-43.21395336",
        "-22.98378468,-43.21244103",
        "-22.98371485,-43.21175715",
        "-22.98372277,-43.21167503",
        "-22.98380422,-43.21134353",
        "-22.98377701,-43.2108971",
        "-22.98396969,-43.21015636",
        "-22.9840095,-43.20970108",
        "-22.98402013,-43.20875605",
        "-22.98407887,-43.20586211",
        "-22.98427082,-43.2054224",
        "-22.98431466,-43.20511196",
        "-22.984317,-43.2040688",
        "-22.98424496,-43.20189143",
        "-22.98435106,-43.20114225",
        "-22.98444614,-43.20066723",
        "-22.98445443,-43.19893627",
        "-22.98456838,-43.19858783",
        "-22.98465896,-43.19733471",
        "-22.98459067,-43.19659047",
        "-22.98439015,-43.19486398",
        "-22.98400208,-43.19442439",
        "-22.98326423,-43.19266823",
        "-22.98312804,-43.19231346",
        "-22.98312931,-43.19227176",
        "-22.98310845,-43.19150178",
        "-22.98166128,-43.19115463",
        "-22.98106387,-43.19112249",
        "-22.98105601,-43.19120689",
        "-22.98084513,-43.19119415",
        "-22.97987522,-43.19101644",
        "-22.97776967,-43.19059977",
        "-22.9772176,-43.19042906",
        "-22.97722583,-43.1906127",
        "-22.97553298,-43.1899871",
        "-22.97384214,-43.18883059",
        "-22.97307102,-43.18851435",
        "-22.97211381,-43.18772975",
        "-22.9718722,-43.18754033",
        "-22.9708124,-43.18646282",
        "-22.96933461,-43.18487205",
        "-22.96928688,-43.18490674",
        "-22.96924215,-43.18484437",
        "-22.96866123,-43.18425152",
        "-22.96829513,-43.18340279",
        "-22.96737156,-43.18206539",
        "-22.96696402,-43.1800991",
        "-22.96565767,-43.17848818",
        "-22.9654418,-43.1772976",
        "-22.9652729,-43.17737947",
        "-22.96470393,-43.17592922",
        "-22.96470185,-43.17573428",
        "-22.9644399,-43.17556118",
        "-22.96417033,-43.17471168",
        "-22.96411761,-43.17469363",
        "-22.96306124,-43.17447338",
        "-22.96199298,-43.17511712",
        "-22.96073121,-43.17563242",
        "-22.9572657,-43.17736211",
        "-22.95721505,-43.17731405",
        "-22.95724863,-43.17731683",
        "-22.95726719,-43.17732168",
        "-22.95715353,-43.17738639",
        "-22.95582974,-43.17755443",
        "-22.95361849,-43.17667295",
        "-22.95281036,-43.17604371",
        "-22.95160232,-43.17529971",
        "-22.9506338,-43.1764238",
        "-22.95030676,-43.17893195",
        "-22.95069999,-43.18122093",
        "-22.94830911,-43.18216638",
        "-22.94732392,-43.18234907",
        "-22.94633497,-43.18240773",
        "-22.94626078,-43.18237357",
        "-22.94423575,-43.1819073",
        "-22.94199166,-43.18210759",
        "-22.94122379,-43.18248415",
        "-22.93894769,-43.18305364",
        "-22.93683732,-43.18372022",
        "-22.9347375,-43.1843609",
        "-22.93317496,-43.18462616",
        "-22.93059813,-43.18602821",
        "-22.93034769,-43.1862122",
        "-22.92001334,-43.19407278",
        "-22.92001334,-43.19407278",
        "-22.91748576,-43.19409597",
        "-22.91688124,-43.194026",
        "-22.91499975,-43.1942333",
        "-22.91671035,-43.19445834",
        "-22.91670826,-43.19517752",
        "-22.91541518,-43.19577751",
        "-22.91438812,-43.19606644",
        "-22.91422679,-43.19605591",
        "-22.9128176,-43.19554149",
        "-22.91182482,-43.19647485",
        "-22.91224555,-43.19871547",
        "-22.9124538,-43.2000147",
        "-22.91288911,-43.20201582",
        "-22.91391274,-43.20475323",
        "-22.91411799,-43.20543636",
        "-22.9144871,-43.20765588",
        "-22.91533957,-43.2089428",
        "-22.91560881,-43.20966232",
        "-22.91560725,-43.20966783",
        "-22.9159616,-43.21142755",
        "-22.916429,-43.21301664",
        "-22.91739473,-43.21522056",
        "-22.91803041,-43.21687984",
        "-22.91734019,-43.21778272",
        "-22.91503034,-43.21880597",
        "-22.91502089,-43.22033993",
        "-22.91611989,-43.22183922",
        "-22.91610185,-43.22183094",
        "-22.915682,-43.2229348",
        "-22.91464592,-43.22416192",
        "-22.91443245,-43.22438721",
        "-22.91402492,-43.22497514",
        "-22.9131682,-43.22550395",
        "-22.91257599,-43.22615885",
        "-22.91257732,-43.22616103",
        "-22.91232101,-43.22656201",
        "-22.91418569,-43.22821685",
        "-22.91475358,-43.22880497",
        "-22.91504556,-43.22902268",
        "-22.91587374,-43.22972536",
        "-22.9160171,-43.22976211",
        "-22.9178126,-43.23139855",
        "-22.91927042,-43.23404262",
        "-22.91809626,-43.23470355",
        "-22.91764126,-43.23477902",
        "-22.91649016,-43.23506864",
        "-22.91647482,-43.23507863",
        "-22.91597535,-43.23520695",
        "-22.91595351,-43.23518191",
        "-22.91470515,-43.23550034",
        "-22.91395496,-43.23579299",
        "-22.91376694,-43.23582758",
        "-22.91390549,-43.23690465",
        "-22.91430057,-43.23856762",
        "-22.91446349,-43.23971763",
        "-22.91484475,-43.24100565",
        "-22.91529946,-43.24324863",
        "-22.91559054,-43.24511666",
        "-22.91575778,-43.2462086",
        "-22.91602689,-43.24750576",
      ];

      const people = [
        5.0,
        5.0,
        5.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        4.0,
        5.0,
        5.0,
        5.0,
        5.0,
        5.0,
        5.0,
        6.0,
        6.0,
        6.0,
        7.0,
        7.0,
        6.0,
        6.0,
        5.0,
        5.0,
        5.0,
        5.0,
        5.0,
        5.0,
        6.0,
        6.0,
        6.0,
        6.0,
        7.0,
        7.0,
        7.0,
        9.0,
        9.0,
        9.0,
        11.0,
        11.0,
        11.0,
        10.0,
        10.0,
        11.0,
        11.0,
        12.0,
        12.0,
        12.0,
        12.0,
        12.0,
        14.0,
        15.0,
        15.0,
        13.0,
        13.0,
        12.0,
        12.0,
        12.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        10.0,
        8.0,
        8.0,
        8.0,
        8.0,
        8.0,
        7.0,
        8.0,
        8.0,
        7.0,
        7.0,
        7.0,
        8.0,
        7.0,
        7.0,
        7.0,
        7.0,
        7.0,
        7.0,
        8.0,
        8.0,
        8.0,
        9.0,
        9.0,
        8.0,
        8.0,
        8.0,
        7.0,
        8.0,
        8.0,
        8.0,
        7.0,
        7.0,
        7.0,
        5.0,
        5.0,
        5.0,
        5.0,
        5.0,
        4.0,
        4.0,
        4.0,
        4.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
      ]

      let colors = [];

      _.each(people, (p, index) => {
        colors[index] = this.getColorFromValue(p);
      });

      var pathQuery = pathValues[0];
      var snappedPoints = [];

      for (let i = 1; i < pathValues.length; i++) {
        if (pathQuery === "") {
          pathQuery += pathValues[i];
        } else {
          pathQuery += `|${pathValues[i]}`;
        }

        if (i % 99 === 0) {

          console.log(pathQuery)
          const data = await axios.get('https://roads.googleapis.com/v1/snapToRoads', {
            params: {
              interpolate: true,
              key: "AIzaSyAnY70pmN83mIyNnWRAxqeydbKsuP5ehIE",
              path: pathQuery
            }
          });
          pathQuery = "";
          snappedPoints = _.concat(snappedPoints, data.data.snappedPoints);
        }
      }

      console.log(snappedPoints)

      if (pathQuery !== "") {
        const data = await axios.get('https://roads.googleapis.com/v1/snapToRoads', {
          params: {
            interpolate: true,
            key: "AIzaSyAnY70pmN83mIyNnWRAxqeydbKsuP5ehIE",
            path: pathQuery
          }
        });

        snappedPoints = _.concat(snappedPoints, data.data.snappedPoints);
      }

      let currColor = colors[0];
      let paths = [];
      let currCoordinates = [];
      var index = 0;
      _.each(snappedPoints, point => {
        let snappedCoordinate = new google.maps.LatLng(point.location.latitude, point.location.longitude);

        if (point.originalIndex && point.originalIndex > 0) {

          paths.push({id: index, color: currColor, snappedCoordinates: currCoordinates});
          currColor = colors[index];
          index++;
          let lastCoord = currCoordinates[currCoordinates.length-1];
          currCoordinates = [lastCoord];
        }

        currCoordinates.push(snappedCoordinate);

      });

      if (currCoordinates.length) {
        paths.push({id: paths.length+1, color: currColor, snappedCoordinates: currCoordinates});
      }

      this.paths = paths;
      this.center = paths[0].snappedCoordinates[0];
    },

    getColorFromValue(n) {
      if (n < 10) {
        return 'green';
      } else if (n < 20) {
        return 'yellow';
      } else if (n < 30) {
        return 'orange';
      }

      return 'red';
    }
  },
  components: {
    Heatmap
  },
};
</script>

<style>
.v-toolbar__content {
  height: auto !important;
  padding: 0;
}
</style>

<style scoped>
.map, .container {
  width: 100%;
  height: 100%;
}
.container.fluid, .container {
  padding: 0 !important;
}
</style>
